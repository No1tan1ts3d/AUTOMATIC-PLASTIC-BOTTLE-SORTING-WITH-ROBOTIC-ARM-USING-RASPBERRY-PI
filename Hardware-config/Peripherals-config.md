## Step-by-Step Guide to Setup and integrate peripherals

## **Peripheral 1: Camera Integration**

### **Method 1: Using the Pi Camera**

#### **Why Prefer Pi Camera?**

- **Efficiency**: The Pi Camera uses the onboard GPU for video processing, reducing CPU usage.
- **Performance**: Provides better performance, lower latency, and higher FPS compared to USB cameras (unless the USB camera has built-in preprocessing).

#### **Setup Steps**

#### **Step 1: Connect the Pi Camera**

- Attach the ribbon cable of the Pi Camera to the CSI port on the Raspberry Pi. 
- **Warning! : Ensure the connection is secure and the cable orientation is correct. If connected incorrectly, it may damage the camera or the Pi. So check the Guide for the correct orientation.**

#### **Step 2:Enable the Camera**

- Open the terminal and run the configuration tool:

    ```bash
    sudo raspi-config
    ```

- Navigate to **Interface Options > Camera**, select **Enable**, and reboot the Raspberry Pi.

#### **Step 3: Testing the camera**

#### **Method 1: Install the Picamera2 Library**

- If using the Raspberry Pi OS 64-bit, install the library:

    ```bash
    sudo apt update
    sudo apt install -y python3-picamera2
    ```

#### **Step 1: Test the Camera**

- Save the following Python script as `camera_test.py` using a text editor (e.g., Geany or Thonny):

     ```python
     from picamera2 import Picamera2
     import cv2

     def main():
         # Initialize Picamera2
         camera = Picamera2()
         preview_config = camera.create_preview_configuration()
         camera.configure(preview_config)
         camera.start()

         print("Press 'q' to exit.")
         try:
             while True:
                 # Capture frame-by-frame
                 frame = camera.capture_array()
                 # Display the frame
                 cv2.imshow("Pi Camera 2 Feed", frame)

                 # Exit loop on 'q' press
                 if cv2.waitKey(1) & 0xFF == ord('q'):
                     break
         except KeyboardInterrupt:
             print("\nExiting...")

         camera.stop()
         cv2.destroyAllWindows()

     if __name__ == "__main__":
         main()
     ```

- Run the script:

    ```bash
    python3 camera_test.py
    ```

- A window displaying the camera feed will open. Press `q` to close.

---

#### **Method 2. Using a USB Camera**

#### **Considerations for USB Camera**

- **CPU Usage**: USB cameras process video using the CPU, potentially causing higher load and lower performance on the Raspberry Pi.
- **When to Use**: Recommended for high-quality USB cameras with built-in preprocessing.

#### **Setup Steps:**

#### **Step 1: Connect the USB Camera**

- Plug the USB camera into any USB port on the Raspberry Pi.

#### **Step 2: Test the Camera**

- Save the following script as `usb_camera_test.py`:

    ```python
    import cv2

    def main():
        # Open the default camera (index 0)
        camera = cv2.VideoCapture(0)

        if not camera.isOpened():
            print("Error: Could not access the camera.")
            return

        print("Press 'q' to exit.")
        try:
            while True:
                # Capture frame-by-frame
                ret, frame = camera.read()

                if not ret:
                    print("Failed to grab frame.")
                    break

                # Display the frame
                cv2.imshow("USB Camera Feed", frame)

                # Exit loop on 'q' press
                if cv2.waitKey(1) & 0xFF == ord('q'):
                    break
        except KeyboardInterrupt:
            print("\nExiting...")

        camera.release()
        cv2.destroyAllWindows()

    if __name__ == "__main__":
        main()
    ```

- Run the script:

    ```bash
    python3 usb_camera_test.py
    ```

- A window displaying the camera feed will open. Press `q` to close.

---

## **Peripheral 2: PWM Control**

### **PWM Overview**

- **Hardware PWM**:
  - Uses dedicated timers for signal generation.
  - Available on:
    - GPIO 12, GPIO 18 (PWM 0)
    - GPIO 13, GPIO 19 (PWM 1)
- **Software PWM**:
  - Generated by the processor.
  - Adds additional computational load.
  - Can experience jitter if the CPU is under load.

### **Method 1: Using Raspberry Pi GPIO for PWM**

#### **Setup Steps**

**Step 1: Install GPIO Library**:

-
    ```bash
    sudo apt update
    sudo apt install -y python3-rpi.gpio
    ```

**Step 2: Control a Servo**:

- Save the following script as `pwm_test.py`:

    ```python
    import RPi.GPIO as GPIO
    import time

    # Pin configuration
    PWM_PIN = 18

    # GPIO setup
    GPIO.setmode(GPIO.BCM)
    GPIO.setup(PWM_PIN, GPIO.OUT)

    # Initialize PWM
    pwm = GPIO.PWM(PWM_PIN, 50)  # 50Hz frequency
    pwm.start(0)

    def set_angle(angle):
        duty_cycle = (angle / 18) + 2
        GPIO.output(PWM_PIN, True)
        pwm.ChangeDutyCycle(duty_cycle)
        time.sleep(1)
        GPIO.output(PWM_PIN, False)
        pwm.ChangeDutyCycle(0)

    try:
        while True:
            angle = float(input("Enter angle (0 to 180): "))
             set_angle(angle)
    except KeyboardInterrupt:
        print("\nExiting...")
    finally:
        pwm.stop()
        GPIO.cleanup()
    ```

**Step 3: Run the script**:

-
    ```bash
    python3 pwm_test.py
    ```

- Enter angles (0â€“180) to control the servo.

---

### **Method 2. Using Arduino Mega for PWM**

#### **Why Use Arduino Mega?**

- Provides 12 hardware PWM pins.
- Offloads the PWM processing load.

#### Testing Arduino Mega as Serial Slave

##### Step 1: Install the Arduino IDE

-
    ```bash
    sudo apt-get install arduino
    ```

##### Step 2: Copy and upload the following code to the Arduino Mega

-
    ```c
    const int LEDPin = 4; // Connect LED to Pin 4
    void setup() {
        Serial.begin(115200);
        pinMode(LEDPin, OUTPUT);
    }

    void loop() {
        if (Serial.available() > 0) {
            int value = Serial.readStringUntil('\n').toInt();
            digitalWrite(LEDPin, value);

            Serial.print("Serial Value is: ");
            Serial.println(value);
        }
    }
    ```

##### Step 3: Test communication from the Raspberry Pi using this Python script

-
    ```python
    import serial
    import time

    # Set up serial communication
    ser = serial.Serial('/dev/ttyACM0', 115200, timeout=1)

    def send_to_arduino(value):
        ser.write(f"{value}\n".encode('utf-8'))
        time.sleep(0.05)

    send_to_arduino(0)
    time.sleep(0.5)
    send_to_arduino(1)
    ```

#### Using Arduino Mega to test servo control

#### **Setup Steps**

**Step 1: Install Arduino IDE**:

-
    ```bash
    sudo apt-get install arduino
    ```

**Step 2: Upload the Following Code to Arduino Mega**:

-
    ```c
    #include <Servo.h>

    Servo servo1;

    void setup() {
        Serial.begin(115200);
        servo1.attach(9); // Connect servo to pin 9
    }

    void loop() {
        if (Serial.available() > 0) {
            int angle = Serial.parseInt();
            servo1.write(angle);
            Serial.print("Servo Angle: ");
            Serial.println(angle);
        }
    }
    ```

**Step 3: Communicate with Arduino**:

- Save the following Python script as `arduino_pwm.py`:

    ```python
    import serial
    import time

    ser = serial.Serial('/dev/ttyACM0', 115200, timeout=1)
    time.sleep(2)  # Wait for connection

    def set_angle(angle):
         ser.write(f"{angle}\n".encode('utf-8'))
         time.sleep(0.1)

    try:
        while True:
            angle = int(input("Enter angle (0-180): "))
            set_angle(angle)
    except KeyboardInterrupt:
        print("\nExiting...")
        ser.close()
    ```

**Step 4: Run the script**:

-
    ```bash
    python3 arduino_pwm.py
    ```

- Ensure the servo pin connected to the Arduino and the code matches before testing.
- Enter angles to control the servo.
- Observe the servo angle movements.

---

Congratulations! You have successfully integrated essential peripherals with the Raspberry Pi. Continue to the [**Arm Logic Development**](arm_logic.md) section for the next steps.
